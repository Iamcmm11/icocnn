# HLS Layer0 éªŒè¯ - çœŸå®æ•°æ®ç»“æ„è¯´æ˜

## ğŸ¯ å…³é”®å‘ç°

è¿è¡Œ `inference_debug.py` å,æˆ‘ä»¬å‘ç° Layer0 çš„**çœŸå®æ•°æ®ç»“æ„**:

### è¾“å…¥å½¢çŠ¶
```
Layer0_IcoConv_input: (1, 103, 1, 1, 5, 4, 8)
                       â†“   â†“   â†“ â†“  â†“  â†“  â†“
                       B   T   C R  charts H  W
```

- **B** = 1 (batch size)
- **T** = 103 (time frames)
- **C** = 1 (input channels, Cin)
- **R** = 1 (orientation channels, Rin)
- **charts** = 5 (icosahedral æœ‰ 5 ä¸ª chart)
- **H** = 4 = 2^r (r=2)
- **W** = 8 = 2^(r+1)

**æ€»é¡¶ç‚¹æ•°**: 5 Ã— 4 Ã— 8 = **160 ä¸ªä½ç½®** (ä¸æ˜¯ 42!)

### è¾“å‡ºå½¢çŠ¶
```
Layer0_IcoConv_output: (1, 103, 32, 6, 5, 4, 8)
                        â†“   â†“   â†“  â†“  â†“  â†“  â†“
                        B   T  Cout Rout charts H W
```

- **Cout** = 32 (output channels)
- **Rout** = 6 (6 ä¸ªæ—‹è½¬æ–¹å‘)
- å…¶ä»–ç»´åº¦ç›¸åŒ

## ğŸ“Š è¿™æ„å‘³ç€ä»€ä¹ˆ?

### 1. ä¸æ˜¯ 42 ä¸ªç‹¬ç«‹é¡¶ç‚¹!

è™½ç„¶ icosahedral grid ç†è®ºä¸Šæœ‰ `10*r^2 + 2 = 42` ä¸ªç‹¬ç«‹é¡¶ç‚¹,ä½†åœ¨ icoCNN çš„å®ç°ä¸­:

- ä½¿ç”¨ **5 ä¸ª charts** çš„ 2D ç½‘æ ¼è¡¨ç¤º
- æ¯ä¸ª chart æ˜¯ `HÃ—W = 4Ã—8 = 32` çš„ç½‘æ ¼
- è¾¹ç•Œä¸Šçš„é¡¶ç‚¹åœ¨ä¸åŒ charts ä¹‹é—´**æœ‰é‡å¤**

è¿™æ˜¯ä¸€ç§**å†—ä½™ä½†é«˜æ•ˆçš„è¡¨ç¤ºæ–¹å¼**!

### 2. é‚»å±…å…³ç³»æ˜¯åŸºäº 2D ç½‘æ ¼çš„

æ¯ä¸ªä½ç½® `(chart, h, w)` çš„ 7 ä¸ªé‚»å±…:
```python
neighbors = [
    (h,   w  ),  # ä¸­å¿ƒ (è‡ªå·±)
    (h+1, w  ),  # ä¸‹
    (h+1, w+1),  # å³ä¸‹
    (h,   w+1),  # å³
    (h-1, w  ),  # ä¸Š
    (h-1, w-1),  # å·¦ä¸Š
    (h,   w-1),  # å·¦
]
```

è¾¹ç•Œå¤„ç†:å¾ªç¯è¾¹ç•Œ (`h % H`, `w % W`)

## ğŸ”§ å¯¹ HLS C++ å®ç°çš„å½±å“

### æ›´æ–°é…ç½®å‚æ•°

ä¿®æ”¹ `ico_types.h`:

```cpp
// Layer0 é…ç½®å‚æ•°
#define R_LEVEL 2
#define NUM_CHARTS 5         // 5 ä¸ª chart
#define CHART_H 4            // 2^r = 4
#define CHART_W 8            // 2^(r+1) = 8
#define NUM_VERTICES_PER_CHART 32  // 4Ã—8 = 32
#define TOTAL_VERTICES 160   // 5Ã—32 = 160
#define TIME_FRAMES 103      // æ—¶é—´å¸§æ•°
#define IN_CHANNELS 1        // Cin * Rin = 1
#define OUT_CHANNELS 32      // Cout
#define OUT_ROTATIONS 6      // Rout
#define NUM_NEIGHBORS 7      // æ¯ä¸ªä½ç½®çš„é‚»å±…æ•°
```

### æ•°æ®å¸ƒå±€

#### è¾“å…¥æ•°æ® `input.txt`
```
Shape: [1, 1, 103, 160]
# æˆ–è€…ç†è§£ä¸º [B, Cin*Rin, T, charts*H*W]
# æ€»å…±: 1 Ã— 1 Ã— 103 Ã— 160 = 16,480 ä¸ªå€¼
```

#### æƒé‡æ•°æ® `weight.txt`
```
Shape: [32, 1, 7]
# [Cout, Cin*Rin, num_neighbors]
# æ€»å…±: 32 Ã— 1 Ã— 7 = 224 ä¸ªå€¼
```

#### é‚»å±…ç´¢å¼• `neighbors.txt`
```
Shape: [160, 7]
# [total_vertices, num_neighbors]
# æ€»å…±: 160 Ã— 7 = 1,120 ä¸ªç´¢å¼•
```

#### è¾“å‡ºæ•°æ® `output.txt`
```
Shape: [1, 32, 6, 103, 160]
# [B, Cout, Rout, T, total_vertices]
# æ€»å…±: 1 Ã— 32 Ã— 6 Ã— 103 Ã— 160 = 3,164,160 ä¸ªå€¼
```

## âœ… éªŒè¯æ­£ç¡®æ€§çš„æ–¹æ³•

æœ‰äº†çœŸå®çš„é‚»å±…å…³ç³»å,ç°åœ¨å¯ä»¥**æ­£ç¡®éªŒè¯** C++ å®ç°:

### æ­¥éª¤ 1: è¿è¡Œ Python debug
```bash
python inference_debug.py
```

ç”Ÿæˆçš„æ–‡ä»¶:
- `input.txt` - 16,480 ä¸ªå€¼
- `weight.txt` - 224 ä¸ªå€¼  
- `bias.txt` - 32 ä¸ªå€¼
- `neighbors.txt` - 1,120 ä¸ªç´¢å¼•
- `output.txt` - 3,164,160 ä¸ªå€¼

### æ­¥éª¤ 2: è¿è¡Œ HLS C++ éªŒè¯
```bash
cd hls_implementation
ç¼–è¯‘å¹¶æµ‹è¯•.bat
```

### æ­¥éª¤ 3: å¯¹æ¯”è¾“å‡º
```bash
# C++ è¾“å‡ºä¼šä¿å­˜åˆ° output_hls.txt
# å¯¹æ¯”ä¸¤ä¸ªæ–‡ä»¶:
diff output.txt output_hls.txt

# æˆ–è€…ç”¨ Python è®¡ç®—è¯¯å·®
python -c "
import numpy as np
ref = np.loadtxt('output.txt', skiprows=1)
hls = np.loadtxt('output_hls.txt', skiprows=1)
err = np.abs(ref - hls).max()
print(f'Max error: {err}')
"
```

### åˆ¤æ–­æ ‡å‡†
- âœ… **è¯¯å·® < 1e-4**: å®Œç¾! C++ å®ç°æ­£ç¡®
- âš ï¸ **è¯¯å·® 1e-4 ~ 1e-2**: å¯ä»¥æ¥å—,å¯èƒ½æ˜¯æµ®ç‚¹ç²¾åº¦
- âŒ **è¯¯å·® > 1e-2**: æœ‰é—®é¢˜,éœ€è¦è°ƒè¯•

## ğŸ“ ä¸ºä»€ä¹ˆè¦ç”¨è¿™ç§å†—ä½™è¡¨ç¤º?

### ä¼˜ç‚¹
1. **è§„åˆ™çš„ 2D ç»“æ„** - å®¹æ˜“å¹¶è¡ŒåŒ–
2. **ç®€å•çš„é‚»å±…ç´¢å¼•** - ä¸éœ€è¦å¤æ‚çš„æ‹“æ‰‘è®¡ç®—
3. **ç¡¬ä»¶å‹å¥½** - é€‚åˆ FPGA å®ç°

### ç¼ºç‚¹
1. **å†—ä½™å­˜å‚¨** - 160 vs 42 ä¸ªé¡¶ç‚¹
2. **é‡å¤è®¡ç®—** - è¾¹ç•Œé¡¶ç‚¹ä¼šè¢«å¤šæ¬¡å¤„ç†

ä½†å¯¹äº FPGA,**è§„åˆ™æ€§ > ç©ºé—´æ•ˆç‡**!

## ğŸ“‹ ä¸‹ä¸€æ­¥æ›´æ–° HLS ä»£ç 

éœ€è¦ä¿®æ”¹:

1. **`ico_types.h`** - æ›´æ–°ç»´åº¦å®šä¹‰
2. **`ico_conv_layer0.cpp`** - è°ƒæ•´ç´¢å¼•è®¡ç®—
3. **`test_ico_conv.cpp`** - æ›´æ–°æ•°æ®åŠ è½½é€»è¾‘

ä¿®æ”¹åé‡æ–°ç¼–è¯‘æµ‹è¯•,**è¾“å‡ºåº”è¯¥ä¸ PyTorch å®Œå…¨ä¸€è‡´**!

---

**ç°åœ¨ä½ å¯ä»¥çœŸæ­£éªŒè¯ C++ å®ç°çš„æ­£ç¡®æ€§äº†! ğŸ‰**
